<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">

<!-- 자유게시판 목록 쿼리문 -->
<select id="listBoard" resultType="map">
	SELECT
		*
	FROM
	(
		SELECT
		      ROW_NUMBER() OVER(ORDER BY BR.POST_DATE) AS NUM
		    , BR.BBS_CODE  AS CODE
		    , U.NICKNAME  AS NICKNAME
		    , BR.TITLE     AS TITLE
		    , BR.CONTENT   AS CONTENT
		    , BT.BBS_TYPE  AS TYPE
		    , BR.POST_DATE AS POST_DATE
		    , BR.HIT_COUNT AS HITCOUNT
		    , NVL(BL2.LIKE_COUNT, 0)    AS LIKE_COUNT
		    , NVL(BC2.CMT_COUNT, 0)    AS CMT_COUNT
		FROM BBS_REG BR
		JOIN USER_REG U ON BR.USER_CODE = U.USER_CODE
		JOIN BBS_TYPE BT ON BR.TYPE_CODE = BT.BBS_TYPE_CODE
		LEFT JOIN (SELECT BL.BBS_CODE, COUNT(*) AS LIKE_COUNT FROM BBS_LIKE BL, BBS_REG BR WHERE BL.BBS_CODE = BR.BBS_CODE GROUP BY BR.BBS_CODE) BL2 
		    ON BR.BBS_CODE = BL2.BBS_CODE
		LEFT JOIN (SELECT BC.BBS_CODE, COUNT(*) AS CMT_COUNT FROM BBS_CMT BC, BBS_REG BR WHERE BC.BBS_CODE = BR.BBS_CODE GROUP BY BC.BBS_CODE) BC2
		    ON BR.BBS_CODE = BC2.BBS_CODE
		<where>
			<if test="searchKey=='name' ">
				INSTR(NICKNAME, #{searchValue}) = 1
			</if>
			<if test="searchKey=='subject' ">
				INSTR(TITLE, #{searchValue}) &gt;= 1
			</if>
			<if test="searchKey=='content' ">
				INSTR(CONTENT, #{searchValue}) &gt;= 1
			</if>
		</where>
		ORDER BY BR.POST_DATE DESC
	)
<![CDATA[
	WHERE NUM <= #{end} and NUM >= #{start}
]]>
	
</select>

<select id="countList" resultType="java.lang.Integer">
	SELECT
    	COUNT(*)
	FROM
	(
	    SELECT
	        BR.BBS_CODE
	        , U.USER_NAME
	        , BR.TITLE
	        , BR.CONTENT
	        , BR.TYPE_CODE
	        , BR.HIT_COUNT
	        , BR.POST_DATE
	        , U.ID
	        , U.NICKNAME
	    FROM BBS_REG BR
	    JOIN USER_REG U ON BR.USER_CODE = U.USER_CODE
	)
	<where>
		<if test="searchKey=='name' ">
			INSTR(NICKNAME, #{searchValue}) = 1
		</if>
		<if test="searchKey=='subject' ">
			INSTR(TITLE, #{searchValue}) &gt;= 1
		</if>
		<if test="searchKey=='content' ">
			DBMS_LOB.INSTR(CONTENT, #{searchValue}) &gt;= 1
		</if>
	</where>
</select>

<select id="searchList" resultType="map">
	SELECT
	      ROW_NUMBER() OVER(ORDER BY BR.POST_DATE) NUM
	    , BR.BBS_CODE  AS CODE
	    , U.NICKNAME  AS NICKNAME
	    , BR.TITLE     AS TITLE
	    , BR.CONTENT   AS CONTENT
	    , BT.BBS_TYPE  AS TYPE
	    , BR.POST_DATE AS POST_DATE
	    , BR.HIT_COUNT AS HITCOUNT
	    , NVL(BL2.LIKE_COUNT, 0)    AS LIKE_COUNT
	    , NVL(BC2.CMT_COUNT, 0)    AS CMT_COUNT
	FROM BBS_REG BR
	JOIN USER_REG U ON BR.USER_CODE = U.USER_CODE
	JOIN BBS_TYPE BT ON BR.TYPE_CODE = BT.BBS_TYPE_CODE
	LEFT JOIN (SELECT BL.BBS_CODE, COUNT(*) AS LIKE_COUNT FROM BBS_LIKE BL, BBS_REG BR WHERE BL.BBS_CODE = BR.BBS_CODE GROUP BY BR.BBS_CODE) BL2 
	    ON BR.BBS_CODE = BL2.BBS_CODE
	LEFT JOIN (SELECT BC.BBS_CODE, COUNT(*) AS CMT_COUNT FROM BBS_CMT BC, BBS_REG BR WHERE BC.BBS_CODE = BR.BBS_CODE GROUP BY BC.BBS_CODE) BC2
	    ON BR.BBS_CODE = BC2.BBS_CODE
	ORDER BY BR.POST_DATE DESC
</select>

<select id="articleLoad" resultType="map">
	SELECT
		*
	FROM
	(
		SELECT
		      ROW_NUMBER() OVER(ORDER BY BR.POST_DATE) AS NUM
		    , BR.BBS_CODE  AS CODE
		    , U.NICKNAME  AS NICKNAME
		    , BR.TITLE     AS TITLE
		    , BR.CONTENT   AS CONTENT
		    , BT.BBS_TYPE  AS TYPE
		    , BR.POST_DATE AS POST_DATE
		    , BR.HIT_COUNT AS HITCOUNT
		    , NVL(BL2.LIKE_COUNT, 0)    AS LIKE_COUNT
		    , NVL(BC2.CMT_COUNT, 0)    AS CMT_COUNT
		FROM BBS_REG BR
		JOIN USER_REG U ON BR.USER_CODE = U.USER_CODE
		JOIN BBS_TYPE BT ON BR.TYPE_CODE = BT.BBS_TYPE_CODE
		LEFT JOIN (SELECT BL.BBS_CODE, COUNT(*) AS LIKE_COUNT FROM BBS_LIKE BL, BBS_REG BR WHERE BL.BBS_CODE = BR.BBS_CODE GROUP BY BR.BBS_CODE) BL2 
		    ON BR.BBS_CODE = BL2.BBS_CODE
		LEFT JOIN (SELECT BC.BBS_CODE, COUNT(*) AS CMT_COUNT FROM BBS_CMT BC, BBS_REG BR WHERE BC.BBS_CODE = BR.BBS_CODE GROUP BY BC.BBS_CODE) BC2
		    ON BR.BBS_CODE = BC2.BBS_CODE
		<where>
			<if test="searchKey=='name' ">
				INSTR(U.NICKNAME, #{searchValue}) = 1
			</if>
			<if test="searchKey=='subject' ">
				INSTR(BR.TITLE, #{searchValue}) &gt;= 1
			</if>
			<if test="searchKey=='content' ">
				INSTR(BR.CONTENT, #{searchValue}) &gt;= 1
			</if>
		</where>
		ORDER BY BR.POST_DATE DESC
	)
	WHERE NUM = ${articleNum }
</select>

</mapper>